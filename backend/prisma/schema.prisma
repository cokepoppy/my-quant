// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [timescaledb]
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  password  String
  role      String   @default("user")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  strategies    Strategy[]
  backtests     Backtest[]
  trades        Trade[]
  accounts      Account[]
  apiKeys       ApiKey[]
  dataImports   DataImport[]
  strategyLogs  StrategyLog[]
  
  @@map("users")
}

model Strategy {
  id          String   @id @default(cuid())
  name        String
  description String?
  code        String
  type        String   // 'technical', 'statistical', 'ml', 'high_frequency'
  status      String   @default("draft") // 'draft', 'active', 'inactive', 'archived'
  parameters  Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  backtests   Backtest[]
  trades      Trade[]
  logs        StrategyLog[]
  
  @@map("strategies")
}

model MarketData {
  id        String   @id @default(cuid())
  symbol    String
  timestamp DateTime
  open      Float
  high      Float
  low       Float
  close     Float
  volume    Float?
  interval  String   // '1m', '5m', '15m', '30m', '1h', '4h', '1d', '1w', '1M'
  source    String   @default("manual") // 'manual', 'api', 'feed'
  
  // TimescaleDB hypertable
  @@map("market_data")
}

model Backtest {
  id              String   @id @default(cuid())
  name            String
  strategyId      String
  userId          String
  startDate       DateTime
  endDate         DateTime
  initialCapital  Float
  finalCapital    Float?
  totalReturn     Float?
  sharpeRatio     Float?
  maxDrawdown     Float?
  winRate         Float?
  totalTrades     Int?
  status          String   @default("pending") // 'pending', 'running', 'completed', 'failed'
  parameters      Json?
  results         Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  strategy        Strategy    @relation(fields: [strategyId], references: [id], onDelete: Cascade)
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  trades          Trade[]
  
  @@map("backtests")
}

model Trade {
  id            String    @id @default(cuid())
  strategyId    String
  userId        String
  backtestId    String?
  symbol        String
  type          String    // 'buy', 'sell'
  side          String    // 'long', 'short'
  quantity      Float
  price         Float
  timestamp     DateTime
  status        String    @default("pending") // 'pending', 'executed', 'cancelled', 'failed'
  commission    Float?
  slippage      Float?
  pnl           Float?
  profit        Float?
  notes         String?
  
  // Relations
  strategy      Strategy  @relation(fields: [strategyId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  backtest      Backtest? @relation(fields: [backtestId], references: [id], onDelete: Cascade)
  
  @@map("trades")
}

model StrategyLog {
  id          String   @id @default(cuid())
  strategyId  String
  userId      String
  level       String   // 'info', 'warning', 'error', 'debug'
  message     String
  metadata    Json?
  timestamp   DateTime @default(now())

  // Relations
  strategy    Strategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("strategy_logs")
}

model Account {
  id            String   @id @default(cuid())
  userId        String
  name          String
  type          String   // 'demo', 'live'
  exchange      String   // 'binance', 'okx', 'huobi', 'bybit'
  accountId     String?  // 交易所账户ID
  balance       Float
  currency      String   @default("USD")
  apiKey        String?
  apiSecret     String?
  passphrase    String?  // OKX等需要passphrase
  testnet       Boolean  @default(false)
  apiPermissions Json?   // API权限配置
  lastSyncAt    DateTime? // 最后同步时间
  syncStatus    String   @default("disconnected") // 'disconnected', 'connected', 'syncing', 'error'
  errorLog      Json?    // 错误日志
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  positions     Position[]
  orders        Order[]
  balances      Balance[]
  trades        Trade[]
  
  @@map("accounts")
}

model Position {
  id            String   @id @default(cuid())
  accountId     String
  symbol        String
  side          String   // 'long', 'short'
  size          Float
  entryPrice    Float
  markPrice     Float?
  pnl           Float?
  roe           Float?   // 收益率
  leverage      Float?
  margin        Float?
  liquidationPrice Float?
  status        String   @default("open") // 'open', 'closed'
  exchangeId    String?  // 交易所持仓ID
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  account       Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@map("positions")
}

model Order {
  id            String   @id @default(cuid())
  accountId     String
  exchangeId    String?  // 交易所订单ID
  clientOrderId String?  // 客户端订单ID
  symbol        String
  type          String   // 'market', 'limit', 'stop', 'stop_limit', 'take_profit'
  side          String   // 'buy', 'sell'
  quantity      Float
  price         Float?
  stopPrice     Float?   // 止损价格
  takeProfit    Float?   // 止盈价格
  status        String   // 'pending', 'open', 'filled', 'cancelled', 'rejected'
  filledQuantity Float    @default(0)
  averagePrice  Float?
  commission    Float?
  feeCurrency   String?
  createTime    DateTime
  updateTime    DateTime?
  executedTime  DateTime?
  metadata      Json?    // 额外的订单信息

  // Relations
  account       Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@map("orders")
}

model Balance {
  id            String   @id @default(cuid())
  accountId     String
  asset         String   // 'BTC', 'ETH', 'USDT'等
  free          Float    // 可用余额
  locked        Float    // 锁定余额
  total         Float    // 总余额
  valueInUSD    Float?   // 美元价值
  lastUpdated   DateTime @default(now())

  // Relations
  account       Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@map("balances")
}

model SystemLog {
  id        String   @id @default(cuid())
  level     String   // 'info', 'warn', 'error', 'debug'
  message   String
  metadata  Json?
  source    String   @default("system")
  createdAt DateTime @default(now())
  
  @@map("system_logs")
}

model TradingLog {
  id            String   @id @default(cuid())
  accountId     String?
  userId        String?
  level         String   // 'info', 'warning', 'error', 'debug'
  category      String   // 'order', 'position', 'balance', 'connection', 'risk', 'execution'
  action        String   // 'create', 'update', 'cancel', 'execute', 'sync', 'error'
  symbol        String?
  message       String
  metadata      Json?
  source        String   @default("trading")
  createdAt     DateTime @default(now())
  
  // Relations
  account       Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@map("trading_logs")
}

model RiskRule {
  id            String   @id @default(cuid())
  name          String
  description   String?
  type          String   // 'position_size', 'loss_limit', 'drawdown', 'margin', 'execution'
  parameters    Json     // 规则参数
  enabled       Boolean  @default(true)
  priority      Int      @default(1) // 1-10, 1为最高优先级
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("risk_rules")
}

model RiskAssessment {
  id            String   @id @default(cuid())
  accountId     String
  ruleId        String
  level         String   // 'low', 'medium', 'high', 'critical'
  score         Float    // 风险评分 0-100
  factors       Json     // 风险因素详情
  triggered     Boolean  @default(false)
  action        String?  // 触发的动作
  createdAt     DateTime @default(now())
  
  // Relations
  account       Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  rule          RiskRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  
  @@map("risk_assessments")
}

model ApiKey {
  id        String   @id @default(cuid())
  userId    String
  name      String
  key       String   @unique
  secret    String
  permissions Json?
  isActive  Boolean  @default(true)
  expiresAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("api_keys")
}

model DataImport {
  id            Int      @id @default(autoincrement())
  fileName      String
  filePath      String
  fileType      String
  fileSize      Int
  dataType      String   // 'market', 'trading', 'strategy', 'user'
  timeFormat    String   @default("iso") // 'iso', 'unix', 'custom'
  dataSource    String?
  status        String   @default("pending") // 'pending', 'processing', 'success', 'failed'
  autoProcess   Boolean  @default(true)
  recordCount   Int?
  errorMessage  String?
  log           String?
  userId        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@map("data_imports")
}