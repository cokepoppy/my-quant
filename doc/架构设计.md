# 量化交易系统架构设计

## 系统总体架构

### 分层架构设计
```
┌─────────────────────────────────────────────────────────────┐
│                    前端展示层 (Vue3)                        │
├─────────────────────────────────────────────────────────────┤
│  用户管理  │  策略开发  │  回测分析  │  实盘交易  │  监控告警  │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    API网关层 (Nginx)                        │
├─────────────────────────────────────────────────────────────┤
│  路由转发  │  负载均衡  │  SSL终止  │  限流控制  │  缓存处理  │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    应用服务层 (Express)                     │
├─────────────────────────────────────────────────────────────┤
│  认证服务  │  数据服务  │  策略服务  │  交易服务  │  监控服务  │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    数据持久层                               │
├─────────────────────────────────────────────────────────────┤
│  PostgreSQL │   Redis    │  TimescaleDB │   文件存储   │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    外部服务层                               │
├─────────────────────────────────────────────────────────────┤
│  数据源  │  券商API  │  交易所API  │  消息通知  │  监控系统  │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块设计

### 1. 前端应用架构 (Vue3)

#### 目录结构
```
frontend/
├── src/
│   ├── assets/          # 静态资源
│   ├── components/      # 公共组件
│   │   ├── charts/      # 图表组件
│   │   ├── forms/       # 表单组件
│   │   └── layout/      # 布局组件
│   ├── views/           # 页面组件
│   │   ├── auth/        # 认证页面
│   │   ├── strategy/    # 策略管理
│   │   ├── backtest/    # 回测分析
│   │   ├── trading/     # 实盘交易
│   │   └── monitoring/  # 监控告警
│   ├── stores/          # Pinia状态管理
│   ├── utils/           # 工具函数
│   ├── api/             # API接口
│   ├── types/           # TypeScript类型定义
│   └── main.ts          # 应用入口
├── public/              # 公共资源
└── package.json
```

#### 核心组件
- **Layout组件**: 整体布局、导航栏、侧边栏
- **Chart组件**: K线图、指标图、回测结果图
- **StrategyEditor**: Monaco Editor策略编辑器
- **DataTable**: 数据表格组件
- **RealTimePanel**: 实时数据面板

### 2. 后端应用架构 (Express)

#### 目录结构
```
backend/
├── src/
│   ├── controllers/     # 控制器
│   ├── services/        # 业务逻辑
│   ├── models/          # 数据模型
│   ├── middleware/      # 中间件
│   ├── routes/          # 路由定义
│   ├── utils/           # 工具函数
│   ├── types/           # TypeScript类型
│   ├── config/          # 配置文件
│   ├── jobs/            # 定时任务
│   ├── socket/          # WebSocket处理
│   └── app.ts           # 应用入口
├── prisma/              # 数据库模式
├── migrations/          # 数据库迁移
├── scripts/             # 脚本文件
└── package.json
```

#### 核心服务
- **AuthService**: 用户认证与授权
- **DataService**: 数据获取与处理
- **StrategyService**: 策略管理与执行
- **BacktestService**: 回测引擎
- **TradingService**: 交易执行
- **MonitoringService**: 监控告警

### 3. 数据库设计

#### PostgreSQL 表结构
```sql
-- 用户表
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(20) DEFAULT 'user',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 策略表
CREATE TABLE strategies (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    code TEXT NOT NULL,
    type VARCHAR(50) NOT NULL,
    status VARCHAR(20) DEFAULT 'draft',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 交易记录表
CREATE TABLE trades (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    strategy_id INTEGER REFERENCES strategies(id),
    symbol VARCHAR(20) NOT NULL,
    type VARCHAR(10) NOT NULL,
    quantity DECIMAL(15,4) NOT NULL,
    price DECIMAL(15,4) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 回测结果表
CREATE TABLE backtest_results (
    id SERIAL PRIMARY KEY,
    strategy_id INTEGER REFERENCES strategies(id),
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    total_return DECIMAL(10,4),
    sharpe_ratio DECIMAL(10,4),
    max_drawdown DECIMAL(10,4),
    win_rate DECIMAL(10,4),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### TimescaleDB 时序数据表
```sql
-- 行情数据表
CREATE TABLE market_data (
    time TIMESTAMPTZ NOT NULL,
    symbol VARCHAR(20) NOT NULL,
    open DECIMAL(15,4),
    high DECIMAL(15,4),
    low DECIMAL(15,4),
    close DECIMAL(15,4),
    volume BIGINT,
    interval VARCHAR(10) NOT NULL
);

-- 转换为超表
SELECT create_hypertable('market_data', 'time');

-- 创建索引
CREATE INDEX ON market_data (symbol, time DESC);
```

### 4. 缓存设计 (Redis)

#### 缓存策略
```typescript
// 用户会话缓存
const userSession = `session:${userId}`;
// 实时行情缓存
const marketData = `market:${symbol}:${interval}`;
// 策略执行状态
const strategyStatus = `strategy:${strategyId}:status`;
// 交易队列
const tradeQueue = `trades:${userId}`;
```

## 数据流设计

### 1. 数据获取流程
```
外部数据源 → 数据采集服务 → 数据清洗 → 数据存储 → 缓存更新 → WebSocket推送
```

### 2. 策略执行流程
```
策略代码 → 参数配置 → 数据输入 → 策略执行 → 信号生成 → 订单生成 → 风险控制 → 交易执行
```

### 3. 回测流程
```
历史数据 → 回测配置 → 策略执行 → 性能分析 → 结果存储 → 报告生成
```

### 4. 实时监控流程
```
数据采集 → 指标计算 → 阈值判断 → 告警触发 → 通知发送 → 日志记录
```

## API接口设计

### RESTful API
```typescript
// 认证相关
POST /api/auth/login
POST /api/auth/register
POST /api/auth/logout
GET /api/auth/profile

// 策略管理
GET /api/strategies
POST /api/strategies
PUT /api/strategies/:id
DELETE /api/strategies/:id
POST /api/strategies/:id/run
POST /api/strategies/:id/stop

// 数据接口
GET /api/data/market/:symbol
GET /api/data/history/:symbol
GET /api/data/indicators/:symbol

// 回测接口
POST /api/backtest/run
GET /api/backtest/results/:id
GET /api/backtest/reports/:id

// 交易接口
GET /api/trades
POST /api/trades
PUT /api/trades/:id
GET /api/trades/positions
GET /api/trades/orders

// 监控接口
GET /api/monitoring/status
GET /api/monitoring/alerts
POST /api/monitoring/alerts
```

### WebSocket事件
```typescript
// 客户端订阅
socket.emit('subscribe', {
  channel: 'market_data',
  symbols: ['BTCUSDT', 'ETHUSDT']
});

// 服务器推送
socket.emit('market_data', {
  symbol: 'BTCUSDT',
  data: { time, open, high, low, close, volume }
});

// 策略状态更新
socket.emit('strategy_update', {
  strategyId: '123',
  status: 'running',
  performance: { return: 0.05, drawdown: 0.02 }
});
```

## 安全设计

### 1. 认证授权
- JWT Token认证
- 角色权限控制
- API访问限流
- 操作日志记录

### 2. 数据安全
- HTTPS/WSS加密传输
- 敏感数据加密存储
- SQL注入防护
- XSS攻击防护

### 3. 交易安全
- 资金密码验证
- 交易限额控制
- 风险控制规则
- 异常交易监控

## 性能优化

### 1. 数据库优化
- 读写分离
- 分库分表
- 索引优化
- 连接池管理

### 2. 缓存优化
- 多级缓存
- 缓存预热
- 缓存击穿防护
- 缓存雪崩防护

### 3. 并发处理
- 异步非阻塞
- 连接池复用
- 负载均衡
- 水平扩展

## 部署架构

### Docker Compose配置
```yaml
version: '3.8'
services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    depends_on:
      - backend
  
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    depends_on:
      - postgres
      - redis
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/quant
      - REDIS_URL=redis://redis:6379
  
  postgres:
    image: timescale/timescaledb:latest-pg14
    environment:
      - POSTGRES_DB=quant
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
  
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - frontend
      - backend

volumes:
  postgres_data:
  redis_data:
```

## 监控告警

### 1. 系统监控
- CPU/内存使用率
- 磁盘空间使用
- 网络流量监控
- 服务健康状态

### 2. 应用监控
- API响应时间
- 数据库查询性能
- WebSocket连接数
- 错误率统计

### 3. 业务监控
- 策略运行状态
- 交易执行情况
- 资金变动监控
- 风险指标监控

## 扩展性设计

### 1. 水平扩展
- 微服务架构
- 无状态服务
- 负载均衡
- 自动扩缩容

### 2. 功能扩展
- 插件化架构
- 自定义指标
- 第三方集成
- 多语言支持

### 3. 数据扩展
- 多数据源支持
- 多市场接入
- 多品种支持
- 多周期数据